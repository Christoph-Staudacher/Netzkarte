<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Netztyp-Karte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    #map { height: 85vh; width: 100%; }
    #filter, #tools {
      padding: 10px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
    #tools {
      top: auto;
      bottom: 10px;
    }
    #legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      font-size: 14px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 8px;
      display: none;
      z-index: 2000;
    }
  </style>
</head>
<body>

<div id="filter">
  <label><input type="checkbox" class="netz-filter" value="TT" checked> TT-Netz</label><br>
  <label><input type="checkbox" class="netz-filter" value="TN" checked> TN-Netz</label><br>
  <label><input type="checkbox" class="netz-filter" value="Unbekannt" checked> Nicht vergeben</label>
</div>

<div id="tools">
  <button onclick="initialisiereKarte()">ğŸ”„ Karte aktualisieren</button>
  <input type="text" id="orderSearch" placeholder="Ordernummer suchen">
  <button onclick="exportCSV()">ğŸ“ CSV Export</button>
</div>

<div id="legend">
  <strong>Legende:</strong><br>
  ğŸ”´ TT > 90â€¯%<br>
  ğŸŸ  TT 1â€“90â€¯%<br>
  ğŸŸ¢ TT = 0â€¯%<br>
  âšª Nicht vergeben
</div>

<div id="loader">ğŸ”„ Lade Daten...</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
  const map = L.map('map').setView([51.1657, 10.4515], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap-Mitwirkende'
  }).addTo(map);

  const farben = {
    TT: "red",
    TN: "green",
    Unbekannt: "gray"
  };

  const aktuelleFilter = new Set(["TT", "TN", "Unbekannt"]);

  const baseId = "appGh6rEXtCNMCrWh";
  const tableName = "Zusammenfassung Angaben Craft OS";
  const apiKey = "patlyiYzU6HAMUiY9.7cfef1ea6fc2a5cd9cc3acebf1347fd04ba1e1d7dd60e9acc7bb77c0caa72f78";

  let allMarker = [];
  let markerCluster;
  let datenArray = [];

  async function fetchDaten() {
    console.log("ğŸ“¡ fetchDaten() gestartet");
    document.getElementById('loader').style.display = 'block';
    let records = [];
    let offset = null;
    try {
      do {
        const res = await fetch(`https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}?pageSize=100&view=Grid%20view${offset ? `&offset=${offset}` : ''}`, {
          headers: {
            Authorization: `Bearer ${apiKey}`
          }
        });
        const data = await res.json();
        records = records.concat(data.records);
        offset = data.offset;
      } while (offset);
    } catch (error) {
      console.error("âŒ Fehler in fetchDaten():", error);
    } finally {
      document.getElementById('loader').style.display = 'none';
    }
    return records.map(rec => {
      const f = rec.fields;
      return {
        id: rec.id,
        plz: f.PLZ,
        netztyp: (f["Netzform Karte"] && f["Netzform Karte"].trim() !== "") ? f["Netzform Karte"].trim() : "Unbekannt",
        ordernummer: f.Ordernummer || "-",
        nb: f.NB || "-",
        lat: f.LAT,
        lng: f.LONG
      };
    }).filter(p => p.lat && p.lng);
  }

  async function initialisiereKarte() {
    console.log("ğŸš€ initialisiereKarte gestartet");
    try {
      datenArray = await fetchDaten();
      console.log("ğŸ“¦ Geladene Daten:", datenArray);
    } catch (err) {
      console.error("âŒ Fehler bei fetchDaten:", err);
    }

    // Rest auskommentieren zur Fehlersuche:
    // if (markerCluster) map.removeLayer(markerCluster);
    // markerCluster = L.markerClusterGroup({
    //   iconCreateFunction: function(cluster) {
    //     ...
    //   }
    // });
    // allMarker = [];
    // datenArray.forEach(...);
    // map.addLayer(markerCluster);
  }

  initialisiereKarte();
</script>
</body>
</html>
