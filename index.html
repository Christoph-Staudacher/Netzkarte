<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Netztyp-Karte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }#map { height: 100vh; width: 100%; }
    #filter, #tools {
      padding: 10px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
    #tools {
      top: auto;
      bottom: 10px;
    }
    #legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      font-size: 14px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 8px;
      display: none;
      z-index: 2000;
    }
  </style>
</head>
<body>

<div id="filter">
  <label><input type="checkbox" class="netz-filter" value="TT" checked> TT-Netz</label><br>
  <label><input type="checkbox" class="netz-filter" value="TN" checked> TN-Netz</label><br>
  <label><input type="checkbox" class="netz-filter" value="Unbekannt" checked> Nicht vergeben</label>
</div>

<div id="tools">
  <button onclick="initialisiereKarte()">🔄 Karte aktualisieren</button>
  <input type="text" id="orderSearch" placeholder="Ordernummer suchen">
  <button onclick="exportCSV()">📁 CSV Export</button>
</div>

<div id="legend">
  <strong>Legende:</strong><br>
  🔴 TT > 90 %<br>
  🟠 TT 1–90 %<br>
  🟢 TT = 0 %<br>
  ⚪ Nicht vergeben
</div>

<div id="loader">🔄 Lade Daten...</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
  const map = L.map('map').setView([51.1657, 10.4515], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap-Mitwirkende'
  }).addTo(map);

  const farben = {
    TT: "red",
    TN: "green",
    Unbekannt: "gray"
  };

  const aktuelleFilter = new Set(["TT", "TN", "Unbekannt"]);

  const baseId = "appGh6rEXtCNMCrWh";
  const tableName = "Zusammenfassung Angaben Craft OS";
  const apiKey = "patlyiYzU6HAMUiY9.7cfef1ea6fc2a5cd9cc3acebf1347fd04ba1e1d7dd60e9acc7bb77c0caa72f78";

  let allMarker = [];
  let markerCluster;
  let datenArray = [];

  async function fetchDaten() {
    document.getElementById('loader').style.display = 'block';
    let allRecords = [];
    let offset = "";
    let url = "";

    do {
      url = `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}?pageSize=100&view=Grid%20view`;
      if (offset) url += `&offset=${offset}`;

      const res = await fetch(url, {
        headers: {
          Authorization: `Bearer ${apiKey}`
        }
      });

      const data = await res.json();
      offset = data.offset || null;

      const records = data.records.map(rec => {
        const f = rec.fields;
        return {
          id: rec.id,
          plz: f.PLZ,
          netztyp: f["Netzform Karte"] || "Unbekannt",
          ordernummer: f.Ordernummer || "-",
          nb: f.NB || "-",
          lat: f.LAT,
          lng: f.LONG
        };
      }).filter(p => p.lat && p.lng);

      allRecords.push(...records);
    } while (offset);

    document.getElementById('loader').style.display = 'none';
    return allRecords;
  }

  function createPopupContent(daten, marker) {
    const popup = document.createElement('div');
    popup.innerHTML = `
      <strong>PLZ: ${daten.plz}</strong><br>
      Ordernummer: ${daten.ordernummer}<br>
      Netzbetreiber: ${daten.nb}<br>
      <label>Netzform:
        <select>
          <option value="TT-Netz">TT-Netz</option>
          <option value="TN-Netz">TN-Netz</option>
          <option value="Unbekannt">Nicht vergeben</option>
        </select>
      </label><br>
      <label>Kommentar:<br><textarea rows="2" data-id="${daten.id}"></textarea></label>
    `;
    const select = popup.querySelector('select');
    select.value = daten.netztyp;
    select.addEventListener('change', async (e) => {
      const neuerTyp = e.target.value;
      const neueFarbe = farben[neuerTyp] || "gray";
      marker.setStyle({ color: neueFarbe, fillColor: neueFarbe });
      marker.options.netztyp = neuerTyp;
      await saveToAirtable(daten.id, neuerTyp);
    });
    return popup;
  }

  async function saveToAirtable(recordId, neuerNetztyp) {
    const res = await fetch(`https://api.airtable.com/v0/${baseId}/${tableName}/${recordId}`, {
      method: "PATCH",
      headers: {
        Authorization: `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ fields: { "Netzform Karte": neuerNetztyp } })
    });
    if (!res.ok) console.error("Fehler beim Speichern in Airtable", await res.text());
  }

  function updateMarkerVisibility(markerMap) {
    for (const m of markerMap) {
      const typ = m.options.netztyp;
      if (aktuelleFilter.has(typ)) {
        m.addTo(map);
      } else {
        map.removeLayer(m);
      }
    }
  }

  document.querySelectorAll('.netz-filter').forEach(cb => {
    cb.addEventListener('change', () => {
      const typ = cb.value;
      cb.checked ? aktuelleFilter.add(typ) : aktuelleFilter.delete(typ);
      updateMarkerVisibility(allMarker);
    });
  });

  function getClusterColor(childMarkers) {
    let tt = 0;
    let tn = 0;
    childMarkers.forEach(m => {
      if (m.options.netztyp === "TT") tt++;
      else if (m.options.netztyp === "TN") tn++;
    });
    const relevant = tt + tn;
    const anteil = relevant ? (tt / relevant) : 0;
    if (anteil === 0) return "green";
    if (anteil < 0.9) return "orange";
    return "red";
  }

  async function initialisiereKarte() {
    datenArray = await fetchDaten();
    if (markerCluster) map.removeLayer(markerCluster);

    markerCluster = L.markerClusterGroup({
      iconCreateFunction: function(cluster) {
        const count = cluster.getChildCount();
        const childMarkers = cluster.getAllChildMarkers();
        const color = getClusterColor(childMarkers);
        return L.divIcon({
          html: `<div style="background-color:${color}; border-radius:50%; padding:5px 10px; color:white;">
                    ${count}
                    <div style='font-size:10px;'>TT: ${childMarkers.filter(m => m.options.netztyp === "TT").length}<br>TN: ${childMarkers.filter(m => m.options.netztyp === "TN").length}</div>
                </div>`,
          className: 'custom-cluster',
          iconSize: L.point(60, 60)
        });
      }
    });

    allMarker = [];

    datenArray.forEach(daten => {
      const color = farben[daten.netztyp] || "gray";
      const marker = L.circleMarker([daten.lat, daten.lng], {
        radius: 8,
        color,
        fillColor: color,
        fillOpacity: 0.8,
        netztyp: daten.netztyp
      });
      marker.bindPopup(createPopupContent(daten, marker));
      markerCluster.addLayer(marker);
      allMarker.push(marker);
    });

    map.addLayer(markerCluster);
  }

  document.getElementById('orderSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const val = this.value.trim();
      const marker = allMarker.find(m => m.getPopup().getContent().includes(`Ordernummer: ${val}`));
      if (marker) {
        map.setView(marker.getLatLng(), 12);
        marker.openPopup();
      }
    }
  });

  function exportCSV() {
    const csvContent = "data:text/csv;charset=utf-8," 
      + "PLZ,Ordernummer,Netzbetreiber,Lat,Lon\n" 
      + datenArray.map(e => `${e.plz},${e.ordernummer},${e.nb},${e.lat},${e.lng}`).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', 'netztyp_export.csv');
    link.click();
  }

  initialisiereKarte();
</script>

</body>
</html>
